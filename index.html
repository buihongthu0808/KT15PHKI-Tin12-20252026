<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hành Trình Săn Kẹo Ngọt</title>
    
    <!-- Tải Tailwind CSS để trang trí giao diện -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tải Babel để trình duyệt hiểu được code React -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Khai báo nơi tải thư viện React và Icon (Import Map) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>

    <style>
        /* Hiệu ứng rung nhẹ cho kẹo */
        @keyframes wiggle {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }
        .animate-wiggle {
            animation: wiggle 1s ease-in-out infinite;
        }
        /* Ngăn chọn văn bản và cuộn trang trên vùng game */
        body {
            overscroll-behavior: none; /* Chặn hiệu ứng kéo nảy (rubber-banding) */
        }
        .game-container {
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body class="bg-slate-50 overscroll-none">
    <div id="root"></div>

    <!-- Mã nguồn trò chơi -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Play, Lock, Check, X, Trophy, Clock, Heart, RotateCcw, 
          ArrowRight, Map as MapIcon, Home, Trees, Waves, Flame, 
          Candy, Skull, Footprints, Star, User, ChevronDown, 
          Volume2, Info, LogOut, School, Smile 
        } from 'lucide-react';

        /**
         * DỮ LIỆU HỌC SINH
         */
        const INITIAL_STUDENTS = {
          "12A1": [
            "Lương Duy Anh", "Nghiêm Tùng Anh", "Nguyễn Huỳnh Tài Đức Anh", "Nguyễn Ngọc Anh", "Nguyễn Việt Anh", 
            "Vũ Thị Minh Anh", "Nguyễn Tuấn Bình", "Nguyễn Tiến Dương", "Bùi Đình Đại", "Phạm Tiến Đạt", 
            "Phùng Tiến Đạt", "Phạm Hải Đăng", "Nguyễn Đỗ Hoàng Hà", "Nguyễn Thu Huế", "Phạm Nguyễn Duy Hưng", 
            "Lê Thị Diệu Hương", "Trần Hà Linh", "Bùi Quang Long", "Trịnh Hải Long", "Phạm Thành Lương", 
            "Phạm Xuân Mạnh", "Nguyễn Quang Minh", "Bùi Xuân Nam", "Phạm Khánh Ngọc", "Hoàng Lê Nguyên", 
            "Chu Nguyễn Phương Oanh", "Nguyễn Thị Thanh Phương", "Bùi Minh Quang", "Nguyễn Như Quỳnh", 
            "Trần Mỹ Tâm", "Nguyễn Chí Thanh", "Đỗ Xuân Thành", "Trịnh Huệ Thiên", "Nguyễn Việt Tiến", 
            "Nguyễn Ngọc Tuấn", "Trần Tuấn Tú"
          ],
          "12A7": [
            "Đặng Thị Quỳnh Anh", "Đinh Đỗ Lan Anh", "Lưu Việt Anh", "Nguyễn Phương Anh", "Nguyễn Trần Tùng Anh", 
            "Nguyễn Tuấn Anh", "Nguyễn Tùng Anh", "Trần Xuân Bắc", "Lê Thị Minh Chuyên", "Trần Thu Cúc", 
            "Bùi Thị Bích Diệp", "Hà Công Doanh", "Đỗ Mạnh Duy", "Nguyễn Tiến Duy", "Phạm Mạnh Dũng", 
            "Cao Hải Đăng", "Pham Minh Đức", "Nguyễn Minh Hiếu", "Trần Minh Hiếu", "Trần Mạnh Hùng", 
            "Trần Tuấn Hưng", "Trần Thùy Linh", "Trần Nhất Long", "Giang Xuân Lộc", "Nguyễn Quỳnh Mai", 
            "Bùi Đức Minh", "Phạm Thúy Nga", "Nguyễn Duy Nguyên", "Phạm Thị Yến Nhi", "Trân Thị Kim Như", 
            "Lưu Thị Mai Phương", "Kiều Như Thành", "Nguyễn Thị Phương Thảo", "Lại Thị Hồng Thuỷ", 
            "Trần Minh Thư", "Trần Minh Thư", "Đỗ Minh Tiến", "Đồng Thu Trang", "Lưu Thị Thu Trang", 
            "Nguyễn Quỳnh Trang", "Trần Thuỳ Trang", "Trần Văn Trọng", "Nguyễn Hoàng Thái Tuấn", 
            "Trân Thanh Tùng", "Trần Thị Hoài Vân", "Lại Thế Vinh"
          ]
        };

        /**
         * DỮ LIỆU CẤP ĐỘ
         */
        const DATA_LEVELS = [
          {
            id: 1,
            title: "Cấp 1: Kiến Thức HTML",
            description: "Các câu hỏi trắc nghiệm về thẻ HTML (40 điểm).",
            theme: "forest",
            icon: <Trees size={32} />,
            color: "bg-emerald-600",
            bgColor: "bg-emerald-50",
            accentColor: "text-emerald-700",
            timePerQuestion: 30, 
            type: "multiple-choice",
            questions: [
              { 
                q: "Phương án nào sau đây mô tả đúng chức năng của thẻ <mark> trong HTML?", 
                options: [
                  "Làm cho văn bản hiển thị in đậm", 
                  "Tô màu nền để đánh dấu văn bản quan trọng", 
                  "Hiển thị văn bản dưới dạng chữ gạch dưới", 
                  "Làm cho văn bản có hiệu ứng nhấp nháy"
                ], 
                correct: 1 
              },
              { 
                q: "Phương án nào sau đây không phải là một cách làm nổi bật văn bản trong HTML?", 
                options: [
                  "Sử dụng thẻ <strong> để làm đậm nội dung.", 
                  "Dùng thẻ <em> để làm nghiêng văn bản.", 
                  "Dùng thẻ <mark> để tô màu nền của văn bản.", 
                  "Dùng thẻ <p> để làm cho chữ in hoa."
                ], 
                correct: 3 
              },
              { 
                q: "Phát biểu nào sau đây mô tả đúng sự khác biệt giữa thẻ <em> và <i> trong HTML?", 
                options: [
                  "<em> chỉ thay đổi màu sắc chữ, còn <i> giúp nhấn mạnh nội dung văn bản", 
                  "<em> giúp nhấn mạnh ý nghĩa nội dung, còn <i> chỉ tạo hiệu ứng in nghiêng mà không mang ý nghĩa ngữ nghĩa", 
                  "<i> không còn được hỗ trợ trong HTML5, còn <em> có thể thay đổi kiểu chữ", 
                  "<em> chỉ có tác dụng làm đậm chữ, còn <i> giúp nội dung dễ đọc hơn"
                ], 
                correct: 1 
              },
              { 
                q: "Để giúp học sinh khiếm thị dễ dàng tiếp cận nội dung (screen reader), nhà phát triển nên sử dụng thẻ nào để đánh dấu các thuật ngữ quan trọng?", 
                options: [
                  "<i>Thuật ngữ quan trọng</i>", 
                  "<b>Thuật ngữ quan trọng</b>", 
                  "<em>Thuật ngữ quan trọng</em>", 
                  "<span>Thuật ngữ quan trọng</span>"
                ], 
                correct: 2 
              }
            ]
          },
          {
            id: 2,
            title: "Cấp 2: Liên Kết HTML",
            description: "Quyết định Đúng hoặc Sai về liên kết HTML (30 điểm).",
            theme: "ocean",
            icon: <Waves size={32} />,
            color: "bg-blue-600",
            bgColor: "bg-blue-50",
            accentColor: "text-blue-700",
            timePerQuestion: 20, 
            type: "multiple-choice",
            questions: [
              { 
                q: "Thuộc tính href của thẻ <a> dùng để chỉ định địa chỉ liên kết.", 
                options: ["Đúng", "Sai"], 
                correct: 0 
              },
              { 
                q: "Để mở liên kết trên chính tab hiện tại, cần thêm thuộc tính target=\"_blank\" vào thẻ <a>.", 
                options: ["Đúng", "Sai"], 
                correct: 1 
              },
              { 
                q: "Muốn chèn một hình ảnh làm siêu liên kết, có thể đặt thẻ <img> bên trong thẻ <a>.", 
                options: ["Đúng", "Sai"], 
                correct: 0 
              }
            ]
          },
          {
            id: 3,
            title: "Cấp 3: Ghép Nối Thẻ HTML",
            description: "Kéo thả để ghép thẻ với chức năng tương ứng (30 điểm).",
            theme: "volcano",
            icon: <Flame size={32} />,
            color: "bg-rose-600",
            bgColor: "bg-rose-50",
            accentColor: "text-rose-700",
            timePerQuestion: 15,
            type: "matching",
            questions: [
              {
                q: "Ghép thẻ HTML với chức năng đúng:",
                pairs: [
                  { left: "<table>", right: "Tạo bảng" },
                  { left: "<tr>", right: "Tạo dòng trong bảng" },
                  { left: "<caption>", right: "Tạo chú thích cho bảng" },
                  { left: "<td>", right: "Tạo ô trong bảng" }
                ]
              },
              {
                q: "Ghép thẻ tạo danh sách với mô tả đúng:",
                pairs: [
                  { left: "<ul>", right: "Danh sách không thứ tự" },
                  { left: "<ol>", right: "Danh sách có thứ tự" },
                  { left: "<li>", right: "Mục trong danh sách" },
                  { left: "<dl>", right: "Danh sách mô tả" }
                ]
              },
              {
                q: "Ghép các thẻ định dạng văn bản với ý nghĩa:",
                pairs: [
                  { left: "<b>", right: "In đậm văn bản" },
                  { left: "<i>", right: "In nghiêng văn bản" },
                  { left: "<u>", right: "Gạch chân văn bản" },
                  { left: "<mark>", right: "Tô sáng (Highlight)" }
                ]
              }
            ]
          }
        ];

        const CandyBackground = () => {
          const candyColors = [
            "text-red-400", "text-orange-400", "text-yellow-400", 
            "text-lime-400", "text-green-400", "text-emerald-400",
            "text-teal-400", "text-cyan-400", "text-sky-400",
            "text-blue-400", "text-indigo-400", "text-violet-400",
            "text-purple-400", "text-fuchsia-400", "text-pink-400", "text-rose-400"
          ];

          return (
            <div className="absolute inset-0 overflow-hidden pointer-events-none z-0">
              {[...Array(50)].map((_, i) => {
                const randomColor = candyColors[Math.floor(Math.random() * candyColors.length)];
                return (
                  <Candy
                    key={i}
                    className={`absolute ${randomColor} opacity-20`}
                    size={Math.random() * 30 + 15}
                    style={{
                      top: `${Math.random() * 100}%`,
                      left: `${Math.random() * 100}%`,
                      transform: `rotate(${Math.random() * 360}deg)`,
                      animation: `pulse ${Math.random() * 3 + 2}s cubic-bezier(0.4, 0, 0.6, 1) infinite`,
                      animationDelay: `${Math.random() * 2}s`
                    }}
                  />
                );
              })}
            </div>
          );
        };

        const shuffleArray = (array) => {
          const newArray = [...array];
          for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
          }
          return newArray;
        };

        const playTickSound = () => {
          try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'triangle'; 
            osc.frequency.setValueAtTime(800, ctx.currentTime);
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
            osc.start();
            osc.stop(ctx.currentTime + 0.1);
          } catch (error) {
            console.error("Audio error", error);
          }
        };

        function App() {
          const [currentScreen, setCurrentScreen] = useState('login'); 
          
          const [studentsData, setStudentsData] = useState(INITIAL_STUDENTS);

          // User Info
          const [selectedClass, setSelectedClass] = useState("");
          const [selectedName, setSelectedName] = useState("");

          const [unlockedLevels, setUnlockedLevels] = useState([1]); 
          const [currentLevelId, setCurrentLevelId] = useState(null);
          
          // Game State
          const [currentQuestions, setCurrentQuestions] = useState([]);
          const [questionIndex, setQuestionIndex] = useState(0);
          
          const [score, setScore] = useState(0);
          const [lives, setLives] = useState(3);
          const [timeLeft, setTimeLeft] = useState(0);
          const [isPaused, setIsPaused] = useState(false);
          const [selectedOption, setSelectedOption] = useState(null);
          const [feedback, setFeedback] = useState(null); 
          
          // Scores
          const [highScores, setHighScores] = useState({}); // Lưu điểm cao nhất
          const [lastScores, setLastScores] = useState({}); // Lưu điểm lần chơi cuối
          const scoreRef = useRef(0);
          const timerRef = useRef(null);

          // Quản lý lượt chơi lại cho từng màn: { 1: true, 2: false, ... }
          const [retriesUsed, setRetriesUsed] = useState({});

          // Matching Game State
          const [connections, setConnections] = useState([]); 
          const [activeDrag, setActiveDrag] = useState(null); 
          const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
          const containerRef = useRef(null);
          const leftRefs = useRef({});
          const rightRefs = useRef({});
          
          // Ref để theo dõi trạng thái kéo ngay lập tức (tránh độ trễ của state)
          const isDraggingRef = useRef(false);

          // --- LOGIC ---

          const handleLogin = () => {
            if (selectedClass && selectedName) {
              setCurrentScreen('instruction'); 
            }
          };

          const handleStartGameFlow = () => {
            setCurrentScreen('map'); 
          }

          const handleFinishGame = () => {
            const newStudentsData = { ...studentsData };
            if (selectedClass && selectedName) {
              newStudentsData[selectedClass] = newStudentsData[selectedClass].filter(
                name => name !== selectedName
              );
            }
            setStudentsData(newStudentsData);

            setSelectedName("");
            setSelectedClass("");
            setHighScores({});
            setLastScores({});
            setUnlockedLevels([1]);
            setScore(0);
            setLives(3);
            setRetriesUsed({}); 
            setCurrentScreen('login');
          };
          
          const startGame = (levelId, isRetryButton = false) => {
            // LOGIC KIỂM TRA QUYỀN CHƠI LẠI
            if (!isRetryButton && unlockedLevels.includes(levelId + 1)) {
                if (retriesUsed[levelId]) {
                    setCurrentLevelId(levelId);
                    const finalScore = lastScores[levelId] !== undefined ? lastScores[levelId] : (highScores[levelId] || 0);
                    setScore(finalScore);
                    scoreRef.current = finalScore; 
                    setCurrentScreen('result');
                    return; 
                } else {
                    setRetriesUsed(prev => ({ ...prev, [levelId]: true }));
                }
            } else if (isRetryButton) {
                 setRetriesUsed(prev => ({ ...prev, [levelId]: true }));
            }

            const level = DATA_LEVELS.find(l => l.id === levelId);
            
            let levelQuestions = [...level.questions];
            levelQuestions = shuffleArray(levelQuestions);

            const processedQuestions = levelQuestions.map((q, qIdx) => {
              if (level.type === 'matching') {
                const pairsWithId = q.pairs.map((p, idx) => ({ ...p, id: `${qIdx}-${idx}` }));
                const leftItems = pairsWithId.map(p => ({ id: p.id, content: p.left }));
                const rightItems = shuffleArray(pairsWithId.map(p => ({ id: p.id, content: p.right })));
                return { ...q, type: 'matching', leftItems, rightItems };
              } else {
                const originalOptions = q.options;
                const correctText = originalOptions[q.correct]; 
                const shuffledOptions = shuffleArray(originalOptions); 
                const newCorrectIndex = shuffledOptions.indexOf(correctText); 
                return { ...q, type: 'multiple-choice', options: shuffledOptions, correct: newCorrectIndex };
              }
            });

            setCurrentQuestions(processedQuestions);
            setCurrentLevelId(levelId);
            setQuestionIndex(0);
            setScore(0);
            scoreRef.current = 0; 
            setLives(3);
            setTimeLeft(level.timePerQuestion);
            setIsPaused(false);
            setSelectedOption(null);
            setFeedback(null);
            setConnections([]);
            
            setCurrentScreen('game');
          };

          const goHome = () => {
            // Không reset scores khi về map để giữ điểm tổng
            // setHighScores({}); // Bỏ
            // setLastScores({}); // Bỏ
            // setUnlockedLevels([1]); // Bỏ, giữ level đã unlock
            // setRetriesUsed({}); // Bỏ
            setCurrentScreen('instruction'); 
          };

          const goMap = () => setCurrentScreen('map');

          // --- QUẢN LÝ THỜI GIAN ---
          useEffect(() => {
            if (currentScreen === 'game' && !isPaused && timeLeft > 0 && feedback === null) {
              if (timeLeft <= 10) playTickSound();
              timerRef.current = setTimeout(() => {
                setTimeLeft(prev => prev - 1);
              }, 1000);
            } else if (timeLeft === 0 && currentScreen === 'game' && feedback === null) {
              const currentQ = currentQuestions[questionIndex];
              if (currentQ && currentQ.type === 'matching') {
                checkMatchingAnswer(true); 
              } else {
                handleWrongAnswer();
              }
            }
            return () => clearTimeout(timerRef.current);
          }, [timeLeft, currentScreen, isPaused, feedback]);

          // --- QUẢN LÝ CHUYỂN CÂU HỎI ---
          useEffect(() => {
            if (currentScreen === 'game' && currentQuestions.length > 0) {
              if (questionIndex >= currentQuestions.length) {
                finishGame();
              } else {
                const level = DATA_LEVELS.find(l => l.id === currentLevelId);
                if (level && feedback === null) {
                   setTimeLeft(level.timePerQuestion);
                   setSelectedOption(null);
                   setFeedback(null); 
                   setConnections([]);
                }
              }
            }
          }, [questionIndex]); 

          // --- MATCHING GAME LOGIC ---
          const getCoordinates = (element) => {
            if (!containerRef.current || !element) return { x: 0, y: 0 };
            const containerRect = containerRef.current.getBoundingClientRect();
            const elemRect = element.getBoundingClientRect();
            return {
              x: elemRect.left - containerRect.left + elemRect.width / 2,
              y: elemRect.top - containerRect.top + elemRect.height / 2
            };
          };

          const handleDragStart = (id, e) => {
            if (feedback !== null) return;
            if (connections.some(c => c.leftId === id)) return;
            
            // Đánh dấu là đang kéo (ngay lập tức)
            isDraggingRef.current = true;
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const containerRect = containerRef.current.getBoundingClientRect();
            setMousePos({ x: clientX - containerRect.left, y: clientY - containerRect.top });
            setActiveDrag({ startId: id });
          };

          const handleDragMove = (e) => {
            // Nếu đang ở trạng thái kéo (dựa vào ref để tránh độ trễ), chặn cuộn trang
            if (isDraggingRef.current) {
                if (e.cancelable) e.preventDefault();
            }

            if (!activeDrag) return;
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            if (containerRef.current) {
              const containerRect = containerRef.current.getBoundingClientRect();
              setMousePos({ x: clientX - containerRect.left, y: clientY - containerRect.top });
            }
          };

          const handleDragEnd = (e) => {
            // Kết thúc kéo
            isDraggingRef.current = false;

            if (!activeDrag) return;
            
            const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
            const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            
            const elements = document.elementsFromPoint(clientX, clientY);
            const rightItem = elements.find(el => el.getAttribute('data-right-id'));
            
            if (rightItem) {
              const rightId = rightItem.getAttribute('data-right-id');
              if (!connections.some(c => c.rightId === rightId)) {
                const newConnection = { leftId: activeDrag.startId, rightId: rightId };
                const newConnections = [...connections, newConnection];
                setConnections(newConnections);
                const currentQ = currentQuestions[questionIndex];
                if (newConnections.length === currentQ.leftItems.length) {
                  checkMatchingAnswer(false, newConnections);
                }
              }
            }
            setActiveDrag(null);
          };

          const checkMatchingAnswer = (isTimeout, finalConnections = connections) => {
            // Chặn gọi nhiều lần
            if (feedback !== null) return;

            const currentQ = currentQuestions[questionIndex];
            if (!currentQ) return; 
            
            let isAllCorrect = true;
            if (finalConnections.length < currentQ.leftItems.length) isAllCorrect = false;
            else {
              finalConnections.forEach(conn => {
                if (conn.leftId !== conn.rightId) isAllCorrect = false;
              });
            }
            if (isAllCorrect && !isTimeout) {
              setFeedback('correct');
              setScore(prev => prev + 10);
              scoreRef.current += 10;
              setTimeout(() => {
                 setFeedback(null); 
                 nextQuestion();
              }, 1500);
            } else {
              setFeedback('wrong');
              setLives(prev => prev - 1);
              if (lives <= 1) setTimeout(finishGame, 1000);
              else setTimeout(() => {
                 setFeedback(null);
                 nextQuestion();
              }, 2000);
            }
          };

          // --- MULTIPLE CHOICE LOGIC ---
          const handleMCAnswer = (optionIndex) => {
            if (feedback !== null) return;
            const currentQ = currentQuestions[questionIndex];
            setSelectedOption(optionIndex);
            if (optionIndex === currentQ.correct) {
              setFeedback('correct');
              setScore(prev => prev + 10);
              scoreRef.current += 10;
              setTimeout(() => {
                 setFeedback(null);
                 nextQuestion();
              }, 1000);
            } else {
              handleWrongAnswer();
            }
          };

          const handleWrongAnswer = () => {
            setFeedback('wrong');
            setLives(prev => prev - 1);
            if (lives <= 1) setTimeout(finishGame, 1000);
            else setTimeout(() => {
               setFeedback(null);
               nextQuestion();
            }, 1500);
          };

          const nextQuestion = () => {
            setQuestionIndex(prev => prev + 1);
          };

          const finishGame = () => {
            setHighScores(prev => ({ ...prev, [currentLevelId]: Math.max(prev[currentLevelId] || 0, scoreRef.current) }));
            setLastScores(prev => ({ ...prev, [currentLevelId]: scoreRef.current }));
            if (!unlockedLevels.includes(currentLevelId + 1)) {
              setUnlockedLevels([...unlockedLevels, currentLevelId + 1]);
            }
            setCurrentScreen('result');
          };

          // --- RENDER FUNCTIONS ---

          const renderLogin = () => (
            <div className="flex flex-col items-center justify-center min-h-screen bg-sky-50 relative overflow-hidden text-slate-800 p-4">
              {/* Background with multiple colored candies */}
              <CandyBackground />
              
              {/* Main Login Card */}
              <div className="z-10 bg-white/90 backdrop-blur-md p-10 rounded-[3rem] shadow-2xl border-8 border-pink-200 flex flex-col items-center max-w-lg w-full animate-fade-in-up transform transition-all hover:scale-[1.01]">
                
                {/* Title Section */}
                <div className="text-center mb-10 w-full">
                  <h1 className="text-2xl md:text-3xl lg:text-4xl font-black text-rose-600 drop-shadow-sm mb-2 tracking-wide leading-tight">
                    HÀNH TRÌNH<br/>
                    <span className="text-3xl md:text-4xl lg:text-5xl text-purple-600 inline-block mt-2 whitespace-nowrap">SĂN KẸO NGỌT</span>
                  </h1>
                  <div className="flex justify-center gap-2 mt-4">
                     <Candy className="text-pink-500 animate-bounce" size={32} />
                     <Candy className="text-purple-500 animate-bounce delay-100" size={32} />
                     <Candy className="text-orange-500 animate-bounce delay-200" size={32} />
                  </div>
                </div>

                {/* Form Section */}
                <div className="w-full space-y-6">
                  
                  {/* Biệt đội / Lớp */}
                  <div className="relative group">
                    <div className="relative bg-pink-50 rounded-2xl p-2 transition-all group-hover:bg-pink-100">
                      <div className="absolute left-4 top-1/2 -translate-y-1/2 text-pink-400 pointer-events-none">
                        <School size={28} />
                      </div>
                      <select 
                        className="w-full p-4 pl-14 bg-transparent border-none font-bold text-xl text-slate-700 appearance-none focus:outline-none cursor-pointer"
                        value={selectedClass}
                        onChange={(e) => {
                          setSelectedClass(e.target.value);
                          setSelectedName(""); 
                        }}
                      >
                        <option value="">-- Chọn Biệt Đội --</option>
                        {Object.keys(studentsData).map(cls => (
                          <option key={cls} value={cls}>{cls}</option>
                        ))}
                      </select>
                      <div className="absolute right-4 top-1/2 -translate-y-1/2 text-pink-400 pointer-events-none">
                        <ChevronDown size={24} strokeWidth={3} />
                      </div>
                    </div>
                  </div>

                  {/* Tên Thợ Săn */}
                  <div className="relative group">
                    <div className="relative bg-indigo-50 rounded-2xl p-2 transition-all group-hover:bg-indigo-100">
                      <div className="absolute left-4 top-1/2 -translate-y-1/2 text-indigo-400 pointer-events-none">
                        <Smile size={28} />
                      </div>
                      <select 
                        className="w-full p-4 pl-14 bg-transparent border-none font-bold text-xl text-slate-700 appearance-none focus:outline-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
                        value={selectedName}
                        onChange={(e) => setSelectedName(e.target.value)}
                        disabled={!selectedClass}
                      >
                        <option value="">-- Chọn Tên Thợ Săn --</option>
                        {selectedClass && studentsData[selectedClass].map((name, idx) => (
                          <option key={idx} value={name}>{name}</option>
                        ))}
                      </select>
                      <div className="absolute right-4 top-1/2 -translate-y-1/2 text-indigo-400 pointer-events-none">
                        <ChevronDown size={24} strokeWidth={3} />
                      </div>
                    </div>
                  </div>

                  {/* Start Button */}
                  <button 
                    onClick={handleLogin}
                    disabled={!selectedClass || !selectedName}
                    className="w-full mt-8 py-5 bg-gradient-to-r from-pink-500 to-indigo-600 hover:from-pink-600 hover:to-indigo-700 disabled:from-slate-300 disabled:to-slate-400 disabled:cursor-not-allowed text-white text-2xl font-black rounded-3xl shadow-[0_8px_0_rgba(0,0,0,0.2)] active:shadow-[0_4px_0_rgba(0,0,0,0.2)] active:translate-y-1 transition-all flex items-center justify-center gap-3 uppercase tracking-wider group"
                  >
                    BẮT ĐẦU NGAY <Play size={28} fill="currentColor" className="group-hover:animate-pulse" />
                  </button>

                </div>
              </div>
            </div>
          );

          const renderInstruction = () => (
            <div className="flex flex-col items-center justify-center min-h-screen bg-indigo-50 text-slate-800 p-4 relative overflow-hidden">
              <CandyBackground />
              <div className="z-10 bg-white/90 backdrop-blur-md p-8 rounded-3xl shadow-2xl border-4 border-indigo-200 max-w-2xl w-full animate-fade-in-up">
                <div className="flex items-center justify-center mb-6">
                  <div className="p-4 bg-indigo-100 rounded-full text-indigo-600 shadow-inner">
                    <Info size={48} />
                  </div>
                </div>
                <h2 className="text-3xl font-black text-center mb-2 text-indigo-800 uppercase">NHIỆM VỤ THỢ SĂN</h2>
                <p className="text-center text-slate-600 mb-8 font-medium">
                  Chào mừng thợ săn <span className="text-indigo-600 font-bold">{selectedName}</span>! 
                  <br/>Để giành được kho báu kẹo ngọt, bạn phải vượt qua 3 cửa ải cam go:
                </p>

                <div className="space-y-4 mb-8">
                  <div className="bg-emerald-50 border-l-8 border-emerald-500 p-4 rounded-r-xl shadow-sm flex items-start gap-4">
                    <div className="p-2 bg-white rounded-full text-emerald-600 shadow-sm"><Trees size={24} /></div>
                    <div>
                      <h3 className="font-bold text-emerald-800 text-lg">Cửa ải 1: Khu Rừng Bí Ẩn</h3>
                      <p className="text-sm text-slate-600">Trả lời các câu hỏi trắc nghiệm về kiến thức HTML.</p>
                      <span className="inline-block mt-1 px-2 py-0.5 bg-emerald-200 text-emerald-800 text-xs font-bold rounded">30 giây / câu</span>
                    </div>
                  </div>

                  <div className="bg-blue-50 border-l-8 border-blue-500 p-4 rounded-r-xl shadow-sm flex items-start gap-4">
                    <div className="p-2 bg-white rounded-full text-blue-600 shadow-sm"><Waves size={24} /></div>
                    <div>
                      <h3 className="font-bold text-blue-800 text-lg">Cửa ải 2: Đại Dương Sâu Thẳm</h3>
                      <p className="text-sm text-slate-600">Quyết định Đúng hoặc Sai về liên kết HTML.</p>
                      <span className="inline-block mt-1 px-2 py-0.5 bg-blue-200 text-blue-800 text-xs font-bold rounded">20 giây / câu</span>
                    </div>
                  </div>

                  <div className="bg-rose-50 border-l-8 border-rose-500 p-4 rounded-r-xl shadow-sm flex items-start gap-4">
                    <div className="p-2 bg-white rounded-full text-rose-600 shadow-sm"><Flame size={24} /></div>
                    <div>
                      <h3 className="font-bold text-rose-800 text-lg">Cửa ải 3: Núi Lửa Phun Trào</h3>
                      <p className="text-sm text-slate-600">Kéo thả để ghép nối các thẻ HTML với chức năng.</p>
                      <span className="inline-block mt-1 px-2 py-0.5 bg-rose-200 text-rose-800 text-xs font-bold rounded">15 giây / câu</span>
                    </div>
                  </div>
                </div>

                <button 
                  onClick={handleStartGameFlow}
                  className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white text-xl font-bold rounded-xl shadow-lg transition-all flex items-center justify-center gap-2"
                >
                  ĐÃ HIỂU, LÊN ĐƯỜNG! <ArrowRight />
                </button>
              </div>
            </div>
          );

          const renderMap = () => {
            const totalLevels = DATA_LEVELS.length;
            const isFinishedAll = unlockedLevels.includes(totalLevels + 1);
            const currentTotalScore = Object.values(lastScores).reduce((a, b) => a + b, 0);

            return (
              <div className="min-h-screen bg-amber-100 flex flex-col relative overflow-hidden">
                <CandyBackground />
                <div className="bg-amber-800 text-amber-50 p-4 shadow-lg z-20 flex justify-between items-center sticky top-0">
                  <button onClick={goHome} className="p-2 hover:bg-amber-700 rounded-full transition-colors"><Home size={24} /></button>
                  <div className="flex items-center gap-2 font-bold text-lg"><Trophy className="text-yellow-400" /> <span>Tổng Điểm: {currentTotalScore}/100</span></div>
                  <div className="w-10"></div>
                </div>
                <div className="flex-1 flex flex-col items-center justify-start py-12 px-4 gap-8 relative overflow-y-auto z-10">
                  <div className="absolute top-20 bottom-20 left-1/2 w-1 -translate-x-1/2 border-l-4 border-dashed border-amber-300 z-0"></div>
                  {DATA_LEVELS.map((level) => {
                    const isUnlocked = unlockedLevels.includes(level.id);
                    const isCompleted = unlockedLevels.includes(level.id + 1); 
                    const currentScore = lastScores[level.id] || 0;
                    return (
                      <div key={level.id} className="relative z-10 w-full max-w-md flex justify-center group">
                        <button onClick={() => isUnlocked && startGame(level.id)} disabled={!isUnlocked} className={`relative w-full max-w-sm p-4 rounded-2xl border-b-8 transition-all flex items-center gap-4 ${isUnlocked ? `${level.color} border-black/20 text-white shadow-xl hover:scale-105 active:translate-y-2` : 'bg-stone-300 border-stone-400 text-stone-500 cursor-not-allowed grayscale'}`}>
                          <div className={`p-3 rounded-full shrink-0 ${isUnlocked ? 'bg-white/20' : 'bg-stone-400/20'}`}>{isUnlocked ? level.icon : <Lock size={24} />}</div>
                          <div className="text-left flex-1"><h3 className="font-bold text-lg leading-tight">{level.title}</h3><p className="text-xs opacity-90">{level.description}</p></div>
                          <div className="flex flex-col items-end shrink-0"><span className="text-xs font-bold uppercase opacity-70">Điểm</span><span className="text-xl font-black">{currentScore}</span></div>
                          {isCompleted && <div className="absolute -top-2 -right-2 bg-yellow-400 text-white p-1 rounded-full border-2 border-white shadow"><Check size={14} strokeWidth={4} /></div>}
                        </button>
                      </div>
                    );
                  })}
                  <div className="z-10 mt-4 w-full max-w-sm">
                     <button disabled={!isFinishedAll} onClick={() => setCurrentScreen('victory')} className={`w-full p-6 rounded-3xl border-b-8 transition-all shadow-2xl flex flex-col items-center gap-2 ${isFinishedAll ? 'bg-gradient-to-r from-pink-500 to-rose-500 border-rose-700 text-white animate-pulse hover:scale-105 cursor-pointer' : 'bg-stone-200 border-stone-300 text-stone-400 cursor-not-allowed'}`}>
                        <Candy size={48} className={isFinishedAll ? 'animate-bounce' : ''} /><span className="font-black text-xl uppercase tracking-widest">{isFinishedAll ? "MỞ KẸO NGAY!" : "HOÀN THÀNH ĐỂ NHẬN KẸO"}</span>
                     </button>
                  </div>
                </div>
              </div>
            );
          };

          const renderGame = () => {
            const level = DATA_LEVELS.find(l => l.id === currentLevelId);
            // GUARD CLAUSE: Chờ dữ liệu được nạp
            if (!level || !currentQuestions || currentQuestions.length === 0) {
                return (
                    <div className={`flex flex-col items-center justify-center min-h-screen ${level ? level.bgColor : 'bg-slate-50'}`}>
                        <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-500 mb-4"></div>
                        <p className="text-xl font-bold text-slate-600 animate-pulse">Đang chuẩn bị câu hỏi...</p>
                    </div>
                );
            }

            const currentQ = currentQuestions[questionIndex];
            // Thêm bảo vệ cho currentQ - Nếu không có câu hỏi (do index vượt quá) thì không render gì cả (sẽ chuyển màn hình ngay)
            if (!currentQ) return null;
            
            if (currentQ.type === 'matching') {
              return (
                <div 
                  className={`flex flex-col min-h-screen ${level.bgColor} text-slate-800 relative select-none game-container`} 
                  onMouseMove={handleDragMove}
                  onTouchMove={handleDragMove}
                  onMouseUp={handleDragEnd}
                  onTouchEnd={handleDragEnd}
                  style={{ touchAction: 'none' }} 
                >
                  <div className="bg-white/90 backdrop-blur p-3 shadow-md sticky top-0 z-30 flex items-center justify-between border-b border-slate-200">
                    <div className="flex items-center gap-3">
                       <div className={`p-2 rounded-lg ${level.color} text-white shadow`}>{level.icon}</div>
                       <div><div className="text-xs font-bold text-slate-400 uppercase">Điểm vòng này</div><div className={`text-xl font-black ${level.accentColor}`}>{score}</div></div>
                    </div>
                    <div className="absolute left-1/2 -translate-x-1/2 flex items-center gap-2 bg-slate-800 text-white px-4 py-1.5 rounded-full shadow-lg"><Clock size={16} className={timeLeft <= 10 ? "animate-pulse text-red-400" : "text-slate-300"} /><span className="font-mono font-bold">{timeLeft}s</span></div>
                    <div className="flex gap-1">{[...Array(3)].map((_, i) => <Heart key={i} className={`w-6 h-6 drop-shadow-sm ${i < lives ? "fill-red-500 text-red-600" : "fill-slate-200 text-slate-300"}`} />)}</div>
                  </div>
                  <div className="flex-1 p-4 flex flex-col">
                    <h2 className="text-xl md:text-2xl font-bold text-center mb-6 text-slate-800">{currentQ.q}</h2>
                    <div className="flex-1 flex justify-between gap-8 relative max-w-4xl mx-auto w-full" ref={containerRef}>
                      <svg className="absolute inset-0 w-full h-full pointer-events-none z-10" style={{overflow: 'visible'}}>
                        {connections.map((c, i) => {
                          const leftEl = leftRefs.current[c.leftId];
                          const rightEl = rightRefs.current[c.rightId];
                          if (!leftEl || !rightEl) return null;
                          const start = getCoordinates(leftEl);
                          const end = getCoordinates(rightEl);
                          let strokeColor = "#94a3b8"; 
                          if (feedback === 'correct') strokeColor = "#22c55e"; 
                          else if (feedback === 'wrong') strokeColor = (c.leftId === c.rightId) ? "#22c55e" : "#ef4444"; 
                          return <line key={i} x1={start.x} y1={start.y} x2={end.x} y2={end.y} stroke={strokeColor} strokeWidth="4" strokeLinecap="round" />;
                        })}
                        {activeDrag && leftRefs.current[activeDrag.startId] && (
                          <line x1={getCoordinates(leftRefs.current[activeDrag.startId]).x} y1={getCoordinates(leftRefs.current[activeDrag.startId]).y} x2={mousePos.x} y2={mousePos.y} stroke="#3b82f6" strokeWidth="4" strokeLinecap="round" strokeDasharray="5,5" />
                        )}
                      </svg>
                      <div className="flex flex-col justify-around w-1/3">
                        {currentQ.leftItems.map((item) => {
                          const isConnected = connections.some(c => c.leftId === item.id);
                          return (
                            <div key={item.id} ref={el => leftRefs.current[item.id] = el} onMouseDown={(e) => handleDragStart(item.id, e)} onTouchStart={(e) => handleDragStart(item.id, e)} className={`p-4 md:p-6 rounded-2xl border-4 font-bold text-center bg-white shadow-md relative z-20 cursor-grab active:cursor-grabbing touch-none ${isConnected ? 'border-slate-400 text-slate-400' : `border-indigo-200 text-indigo-700 hover:border-indigo-400`} ${activeDrag?.startId === item.id ? 'ring-4 ring-blue-300' : ''}`} style={{ touchAction: 'none' }}>
                              {item.content}
                              <div className="absolute right-[-10px] top-1/2 -translate-y-1/2 w-4 h-4 bg-slate-300 rounded-full border-2 border-white" />
                            </div>
                          );
                        })}
                      </div>
                      <div className="flex flex-col justify-around w-1/3">
                        {currentQ.rightItems.map((item) => {
                          const isConnected = connections.some(c => c.rightId === item.id);
                          return (
                            <div key={item.id} ref={el => rightRefs.current[item.id] = el} data-right-id={item.id} className={`p-4 md:p-6 rounded-2xl border-4 font-bold text-center bg-white shadow-md relative z-20 transition-all ${isConnected ? 'border-slate-400 text-slate-400 bg-slate-50' : 'border-orange-200 text-orange-800'}`} style={{ touchAction: 'none' }}>
                              {item.content}
                              <div className="absolute left-[-10px] top-1/2 -translate-y-1/2 w-4 h-4 bg-slate-300 rounded-full border-2 border-white" />
                            </div>
                          );
                        })}
                      </div>
                    </div>
                    {feedback && <div className={`mt-4 text-center font-black text-xl animate-bounce ${feedback === 'correct' ? 'text-green-600' : 'text-red-600'}`}>{feedback === 'correct' ? "CHÍNH XÁC! TUYỆT VỜI!" : "SAI RỒI! HÃY CỐ GẮNG HƠN!"}</div>}
                  </div>
                </div>
              );
            }

            const optionLabels = ["A", "B", "C", "D"];
            return (
              <div className={`flex flex-col min-h-screen ${level.bgColor} text-slate-800 relative`}>
                <div className="bg-white/90 backdrop-blur p-3 shadow-md sticky top-0 z-30 flex items-center justify-between border-b border-slate-200">
                  <div className="flex items-center gap-3">
                     <div className={`p-2 rounded-lg ${level.color} text-white shadow`}>{level.icon}</div>
                     <div><div className="text-xs font-bold text-slate-400 uppercase">Điểm vòng này</div><div className={`text-xl font-black ${level.accentColor}`}>{score}</div></div>
                  </div>
                  <div className="absolute left-1/2 -translate-x-1/2 flex items-center gap-2 bg-slate-800 text-white px-4 py-1.5 rounded-full shadow-lg"><Clock size={16} className={timeLeft <= 10 ? "animate-pulse text-red-400" : "text-slate-300"} /><span className="font-mono font-bold">{timeLeft}s</span></div>
                  <div className="flex gap-1">{[...Array(3)].map((_, i) => <Heart key={i} className={`w-6 h-6 drop-shadow-sm ${i < lives ? "fill-red-500 text-red-600" : "fill-slate-200 text-slate-300"}`} />)}</div>
                </div>
                <div className="flex-1 flex flex-col items-center justify-center p-4">
                  <div className="w-full max-w-3xl">
                    <div className="bg-white rounded-3xl shadow-xl border-b-8 border-slate-100 p-6 md:p-10 mb-8 text-center relative overflow-hidden">
                       <div className="absolute top-0 left-0 w-full h-2 bg-slate-100"><div className={`h-full transition-all duration-500 ${level.color}`} style={{width: `${((questionIndex)/currentQuestions.length)*100}%`}}></div></div>
                       <h2 className="text-2xl md:text-3xl font-bold mt-4 mb-2 text-slate-800">{currentQ.q}</h2>
                       <p className="text-slate-400 text-sm font-medium">Câu hỏi {questionIndex + 1} / {currentQuestions.length}</p>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {currentQ.options.map((opt, idx) => {
                        let statusClass = "bg-white border-slate-200 text-slate-600 hover:border-slate-300 hover:bg-slate-50";
                        if (feedback) {
                           if (idx === currentQ.correct) statusClass = "bg-emerald-500 border-emerald-600 text-white ring-4 ring-emerald-200";
                           else if (idx === selectedOption) statusClass = "bg-rose-500 border-rose-600 text-white opacity-50";
                           else statusClass = "opacity-40 bg-slate-100 border-slate-200";
                        }
                        return (
                          <button key={idx} onClick={() => handleMCAnswer(idx)} disabled={feedback !== null} className={`relative p-5 rounded-2xl border-b-4 font-bold text-lg transition-all text-left ${statusClass} ${!feedback ? 'shadow-sm active:border-b-0 active:translate-y-1' : ''}`}>
                            <span className="font-black mr-2 opacity-60">{optionLabels[idx]}.</span>{opt}
                            {feedback === 'correct' && idx === currentQ.correct && <Check className="absolute right-4 top-1/2 -translate-y-1/2" strokeWidth={3} />}
                            {feedback === 'wrong' && idx === selectedOption && <X className="absolute right-4 top-1/2 -translate-y-1/2" strokeWidth={3} />}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>
            );
          };

          const renderResult = () => {
            const level = DATA_LEVELS.find(l => l.id === currentLevelId);
            const isLastLevel = currentLevelId === DATA_LEVELS.length;
            // Kiểm tra xem có phải đang ở trạng thái "Hết lượt chơi lại" không (được đánh dấu bởi retryUsed[level.id])
            const isOutOfRetries = retriesUsed[level.id];

            return (
              <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 relative overflow-hidden">
                <CandyBackground />
                <div className="bg-white w-full max-w-md rounded-3xl p-8 text-center shadow-2xl relative z-10 animate-fade-in-up">
                   <div className="absolute -top-12 left-1/2 -translate-x-1/2">
                      <div className="w-24 h-24 rounded-full border-8 border-white shadow-xl flex items-center justify-center bg-yellow-400"><Trophy size={48} className="text-yellow-900" /></div>
                   </div>
                   <div className="mt-10 mb-6">
                     <h2 className="text-3xl font-black uppercase text-slate-700">Kết Thúc Màn {currentLevelId}</h2>
                     <p className="text-slate-500 font-medium mt-2">Bạn đã hoàn thành phần chơi này.</p>
                     {/* Hiển thị thông báo nếu hết lượt chơi lại */}
                     {isOutOfRetries && (
                        <p className="text-red-500 font-bold mt-2 animate-pulse">Bạn đã sử dụng hết lượt chơi lại ở màn này!</p>
                     )}
                   </div>
                   <div className="bg-slate-50 rounded-xl p-6 mb-6 border border-slate-100">
                      <div className="text-xs font-bold text-slate-400 uppercase mb-1">Điểm đạt được</div>
                      <div className="text-4xl font-black text-slate-800">{scoreRef.current}</div>
                   </div>
                   <div className="space-y-3">
                      {isLastLevel ? (
                        <button onClick={() => setCurrentScreen('victory')} className="w-full py-4 bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white font-bold rounded-xl shadow-lg shadow-rose-200 transition-all flex items-center justify-center gap-2 animate-pulse"><Candy size={20} /> XEM PHẦN THƯỞNG</button>
                      ) : (
                        <button onClick={() => startGame(currentLevelId + 1)} className="w-full py-4 bg-emerald-500 hover:bg-emerald-600 text-white font-bold rounded-xl shadow-lg shadow-emerald-200 transition-all flex items-center justify-center gap-2">Qua màn tiếp theo <ArrowRight /></button>
                      )}
                      
                      {/* Ẩn nút Chơi lại nếu đã hết lượt */}
                      {!isOutOfRetries ? (
                        <button onClick={() => startGame(currentLevelId, true)} className="w-full py-3 bg-white border-2 border-indigo-200 text-indigo-600 hover:bg-indigo-50 font-bold rounded-xl transition-all flex items-center justify-center gap-2"><RotateCcw size={18} /> Chơi lại màn này (Còn 1 lượt)</button>
                      ) : (
                        <div className="text-sm text-slate-400 italic py-2">Bạn đã sử dụng quyền chơi lại ở màn này.</div>
                      )}
                      <button onClick={goMap} className="w-full py-3 text-slate-400 font-bold hover:text-slate-600">Xem bản đồ</button>
                   </div>
                </div>
              </div>
            );
          };

          const renderVictory = () => {
            // SỬA: Tính tổng điểm từ lastScores (điểm lần chơi cuối)
            const totalScore = Object.values(lastScores).reduce((a, b) => a + b, 0);
            
            let candyCount = 0;
            let message = "";
            if (totalScore < 50) { candyCount = 1; message = "Cố gắng hơn nhé! Tặng bạn một chiếc kẹo động viên."; } 
            else if (totalScore <= 70) { candyCount = 3; message = "Làm tốt lắm! Phần thưởng cho bạn đây."; } 
            else if (totalScore <= 90) { candyCount = 5; message = "Quá xuất sắc! Bạn nhận được túi kẹo lớn."; } 
            else { candyCount = 8; message = "TUYỆT ĐỐI! BẠN LÀ THIÊN TÀI SĂN KẸO!"; }

            return (
              <div className="min-h-screen bg-gradient-to-b from-purple-600 to-indigo-800 flex items-center justify-center p-4 text-white text-center relative overflow-hidden">
                 <div className="absolute inset-0 pointer-events-none">
                    {[...Array(20)].map((_, i) => <Candy key={i} className="absolute text-white/10 animate-pulse" size={Math.random() * 50 + 30} style={{ top: `${Math.random() * 100}%`, left: `${Math.random() * 100}%`, animationDuration: `${Math.random() * 2 + 1}s`, transform: `rotate(${Math.random() * 360}deg)` }} />)}
                 </div>
                 <div className="max-w-lg w-full bg-white/10 backdrop-blur-md rounded-3xl p-8 border border-white/20 shadow-2xl animate-scale-up z-10">
                    <h1 className="text-4xl font-black mb-2 text-yellow-300 drop-shadow-md">KẾT QUẢ CHUNG CUỘC</h1>
                    
                    {/* Bảng điểm chi tiết */}
                    <div className="mb-6 grid grid-cols-3 gap-2 w-full">
                        {DATA_LEVELS.map((level, idx) => {
                            const score = lastScores[level.id] || 0;
                            return (
                                <div key={idx} className="bg-white/20 rounded-xl p-2 flex flex-col items-center">
                                    <span className="text-xs font-bold text-slate-200 mb-1 uppercase">Màn {level.id}</span>
                                    <span className="text-2xl font-black">{score}</span>
                                </div>
                            )
                        })}
                    </div>
                    
                    <div className="text-6xl font-black mb-6">{totalScore}/100</div>

                    <div className="bg-white/90 rounded-2xl p-6 mb-6 text-slate-800">
                       <p className="text-xl font-bold mb-2 text-sky-600">{selectedName} - Biệt đội {selectedClass}</p>
                       <p className="text-lg font-bold mb-4">{message}</p>
                       <div className={`mx-auto w-fit gap-4 animate-bounce ${candyCount > 5 ? 'grid grid-cols-4' : 'flex justify-center'}`}>
                          {[...Array(candyCount)].map((_, i) => <Candy key={i} size={40} className="text-yellow-500 fill-yellow-400 drop-shadow-md" style={{animationDelay: `${i * 100}ms`}} />)}
                       </div>
                       <p className="mt-4 font-bold text-rose-500 uppercase">Bạn nhận được {candyCount} chiếc kẹo!</p>
                    </div>
                    {/* Nút Kết thúc thay vì Chơi lại */}
                    <button 
                      onClick={handleFinishGame}
                      className="px-8 py-4 bg-rose-500 hover:bg-rose-600 text-white text-xl font-bold rounded-full shadow-lg transition-transform hover:scale-105 active:scale-95 flex items-center justify-center gap-2 mx-auto"
                    >
                       <LogOut size={24} /> KẾT THÚC
                    </button>
                 </div>
              </div>
            );
          };

          return (
            <div className="font-sans antialiased">
              {currentScreen === 'login' && renderLogin()}
              {currentScreen === 'instruction' && renderInstruction()}
              {currentScreen === 'map' && renderMap()}
              {currentScreen === 'game' && renderGame()}
              {currentScreen === 'result' && renderResult()}
              {currentScreen === 'victory' && renderVictory()}
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
